import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import gender_guesser.detector as gender

# Inicializar detector de género
detector = gender.Detector()

# Configuración visual
plt.style.use('seaborn-v0_8-darkgrid')
sns.set(rc={'figure.figsize': (12, 6)})

def cargar_y_limpiar_datos(file_path="mundial_tweets.csv"):
    """Carga el CSV y procesa fechas, horas y extrae el primer nombre."""
    df = pd.read_csv(file_path)
    df["Date"] = pd.to_datetime(df["Date"], errors="coerce")
    df["Fecha"] = df["Date"].dt.date
    df["Hora"] = df["Date"].dt.time
    df = df.drop(columns=["Date"])
    df["Primer_Nombre"] = df["Name"].apply(lambda x: x.split()[0] if pd.notna(x) else None)
    return df

def asignar_sexo(nombre, detector):
    """Asigna un sexo basado en el primer nombre."""
    if pd.notnull(nombre):
        gender_str = detector.get_gender(nombre)
        mapa_sexo = {
            "male": "Hombre",
            "female": "Mujer",
            "mostly_male": "Hombre",
            "mostly_female": "Mujer",
            "unknown": "Desconocido",
            "andy": "Ambiguo"
        }
        return mapa_sexo.get(gender_str, "Desconocido")
    return "Desconocido"

if __name__ == "__main__":
    df = cargar_y_limpiar_datos()

    # Análisis de sexo de los usuarios
    df["Sexo"] = df["Primer_Nombre"].apply(lambda x: asignar_sexo(x, detector))
    sexo_counts = df['Sexo'].value_counts()
    total_sexo = sexo_counts.sum()
    labels = [f"{sexo} ({count}, {count/total_sexo:.1%})" for sexo, count in sexo_counts.items()]

    # Visualización
    plt.close()
    sexo_counts.plot(kind="pie", autopct='%1.1f%%', startangle=90, labels=labels)
    plt.title("¿Qué sexo publica más?")
    plt.ylabel("")
    plt.tight_layout()
    plt.show()

    # Mostrar resultados en consola
    print("\nAnálisis de sexo de los usuarios:")
    print(sexo_counts)
    print("\n⚠️ Advertencia: El análisis de sexo se basa en el primer nombre y puede tener un margen de error considerable, especialmente con nombres poco comunes, apodos o nombres ambiguos.")